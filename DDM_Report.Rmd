---
title: 'Closer look at DDM parameter estimates'
output:
github_document:
toc: yes
toc_float: yes
---

```{r, message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(lme4)
library(GGally)
library(jsonlite)
library(psych)
library(rmarkdown)
library(psych)
library(stringr)
library(plotly)
library(jsonlite)
library(DT)
sem <- function(x) {sd(x, na.rm=T) / sqrt(length(x))}
render_this <- function(){rmarkdown::render('DDM_Report.Rmd', output_dir = '/Users/zeynepenkavi/Dropbox/PoldrackLab/SRO_Retest_Report', html_notebook(toc = T, toc_float = T, code_folding = 'hide'))}
options(scipen = 1, digits = 4)
```

How much do hddm parameters change when fitting to whole vs partial sample

Summary of absolute difference in parameter estimates.

```{r}
#T1 data before replacing hddm variables that are fit to retest subjects only
pre_correction <- read.csv('/Users/zeynepenkavi/Dropbox/PoldrackLab/SRO_Retest_Analyses/retest_subs_test_data_preddm_correction.csv')
#T1 data after replacing hddm variables that are fit to retest subjects only
post_correction <- read.csv('/Users/zeynepenkavi/Dropbox/PoldrackLab/SRO_Retest_Analyses/retest_subs_test_data.csv')

hddm_cols = grep('hddm', names(pre_correction), value =T)

#Extract only hddm variable columns
pre_correction = pre_correction[,c("sub_id", hddm_cols)]
post_correction = post_correction[,c("sub_id", hddm_cols)]

pre_correction = pre_correction %>% mutate(pre_post = "pre")
post_correction = post_correction %>% mutate(pre_post = "post")

all_hddm = rbind(pre_correction, post_correction)

all_hddm %>%
  gather(key, value, -sub_id, -pre_post) %>%
  arrange(sub_id) %>%
  spread(pre_post, value) %>%
  mutate(abs_diff = pre-post) %>%
  group_by(key) %>%
  summarise(mean_abs_diff = mean(abs_diff, na.rm=T),
            median_abs_diff = median(abs_diff, na.rm=T),
            min_abs_diff = min(abs_diff, na.rm=T),
            max_abs_diff = max(abs_diff, na.rm=T),
            sem_abs_diff = sem(abs_diff)) %>%
  ggplot(aes(reorder(key, mean_abs_diff), mean_abs_diff))+
  geom_point()+
  geom_errorbar(aes(ymin = mean_abs_diff-sem_abs_diff, ymax = mean_abs_diff+sem_abs_diff), position=position_dodge(0.9), width = 0.25)+
  theme_bw()+
  geom_hline(yintercept=0, linetype='dashed', color='red')+
  ylab("Mean absolute diff after refitting T1 data for T2 subjects")+
  xlab("")+
  coord_flip()
```

Are the variables we see the changes on differ depending on the sample they were fitted due to transformation? Below we are looking at absolute differences of all parameter estimates without any transformations but still comparing whether refitting the HDDM for the T2 participants (instead of all T1 participants) makes a difference.  

These are probably the results that we should pay more attention to because comparing transformed variables in the previous graph does not reflect transformations on the same sample. The data before the hddm correction are transformed for the full T1 sample and then subsetted to only include the T2 sample whereas the data including the refitted HDDM parameters is transformed using onlyt he T2 sample. I could compare data that are transformed on the same sample but it is probably better to look at raw model outputs since we are looking at absolute differences between parameter estimates (instead of doing any statistics with any normality assumptions).

*Conclusion from the graph below:* Overall the refitting does not seem to lead to any difference (except perhaps for specific DPX conditions)

```{r}
#T1 data without any transformations fit for all subjects (instead of T2 subjects only)
raw_pre_correction <- read.csv('/Users/zeynepenkavi/Dropbox/PoldrackLab/SRO_Retest_Analyses/raw_retest_subs_test_data_preddm_correction.csv')

replace_hddm_vars = data.frame(grep('hddm', names(raw_pre_correction), value=T, perl=T))
names(replace_hddm_vars) = c('var')

raw_pre_correction = raw_pre_correction[,c("sub_id", as.character(replace_hddm_vars$var))]

hddm_fix_retest_subs_test_data = raw_pre_correction

#All hddm refits of T1 data for T2 subjects without any transformations
raw_hddm_refits <- read.csv('/Users/zeynepenkavi/Documents/PoldrackLabLocal/Self_Regulation_Ontology/Data/Retest_03-21-2017/hddm_refits_exhaustive.csv')

#Loop to replace the refitted HDDM parameter values (still without transformations)
for(i in 1:length(names(hddm_fix_retest_subs_test_data))){
  if(names(hddm_fix_retest_subs_test_data)[i] %in% replace_hddm_vars$var){
    hddm_fix_retest_subs_test_data[,names(hddm_fix_retest_subs_test_data)[i]] <- raw_hddm_refits[,names(hddm_fix_retest_subs_test_data)[i]]
  }
}

raw_post_correction <- hddm_fix_retest_subs_test_data

raw_pre_correction = raw_pre_correction %>% mutate(pre_post = "pre")
raw_post_correction = raw_post_correction %>% mutate(pre_post = "post")

raw_all_hddm = rbind(raw_pre_correction, raw_post_correction)

raw_all_hddm %>%
  gather(key, value, -sub_id, -pre_post) %>%
  arrange(sub_id) %>%
  spread(pre_post, value) %>%
  mutate(abs_diff = pre-post) %>%
  group_by(key) %>%
  summarise(mean_abs_diff = mean(abs_diff, na.rm=T),
            median_abs_diff = median(abs_diff, na.rm=T),
            min_abs_diff = min(abs_diff, na.rm=T),
            max_abs_diff = max(abs_diff, na.rm=T),
            sem_abs_diff = sem(abs_diff)) %>%
  ggplot(aes(reorder(key, mean_abs_diff), mean_abs_diff))+
  geom_point()+
  geom_errorbar(aes(ymin = mean_abs_diff-sem_abs_diff, ymax = mean_abs_diff+sem_abs_diff), position=position_dodge(0.9), width = 0.25)+
  theme_bw()+
  geom_hline(yintercept=0, linetype='dashed', color='red')+
  ylab("Mean absolute difference after refit")+
  xlab("")+
  coord_flip()
```

How do reliabilities change w sample size (refit from 50 to 150) both for EZ and hddm (gives a prescriptive recommendation on which method to use depending on sample size)

```{r}
all_ddm_sample_size_summary = read.csv('/Users/zeynepenkavi/Dropbox/PoldrackLab/SRO_Retest_Analyses/all_ddm_sample_size_summary.csv')

all_ddm_sample_size_summary %>%
  ggplot(aes(icc_median, dv, color=factor(N)))+
  geom_point()+
  theme_bw()
```


Turn off h of ddm and see if it makes a difference