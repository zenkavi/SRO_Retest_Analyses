---
title: "Neuroecon Poster Figures"
output:
  html_document: default
  pdf_document: default
---

```{r, message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(GGally)
library(stringr)
library(plotly)
library(xtable)
sem <- function(x) {sd(x, na.rm=T) / sqrt(length(x))}
options(scipen = 1, digits = 4, width = 500)
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}
```

Variables that will be used in the figures for the poster

```{r}
poster_vars <- read.csv('../input/poster_var_list.csv', header=F)

names(poster_vars) = "var"
```

# Lit review figure

Read data in

```{r}
fig_data <- read.csv('../input/lit_review_figure.csv')

fig_data_poster = fig_data[fig_data$dv %in% poster_vars$var,]
```

Split dv column, organize by model fit or raw measure

```{r warning=FALSE, message=FALSE}
fig_data_poster = fig_data_poster %>%
  separate(dv, c("task_group", "var"), sep="\\.",remove=FALSE,extra="merge") %>%
  mutate(task_group = factor(task_group, levels = task_group[order(task)]),
         raw1_fit0 = grepl('raw', variable_type),
         type = as.character(type)) %>%
  separate(var, c("var"), sep="\\.",remove=TRUE,extra="drop") %>%
  mutate(task_group = gsub("_", " ", task_group),
         var = gsub("_", " ", var)) %>%
  arrange(task_group, raw1_fit0, var)
```

```{r}
p1_legend = fig_data_poster %>%
  filter(task == 'task') %>%
ggplot(aes(y = var, x = retest_reliability)) + 
  geom_point(aes(size=sample_size, shape=type))+
  facet_grid(task_group~., switch = "y", scales = "free_y", space = "free_y") +
  theme(panel.spacing = unit(0.5, "lines"), 
        strip.placement = "outside",
        strip.text.y = element_text(angle=180),
        panel.background = element_rect(fill = NA),
        panel.grid.major = element_line(colour = "grey80"),
        legend.position = 'bottom', 
        legend.key.size = unit(2, "cm")) + 
  xlab("")+
  ylab("")+
  scale_x_continuous(limits = c(-0.25,1), breaks=c(-0.25, 0, 0.25, 0.5, 0.75, 1))+
  scale_shape_manual(breaks = sort(fig_data$type), values = c(15, 16, 17, 3))

p1 = fig_data_poster %>%
  filter(task == 'task') %>%
ggplot(aes(y = var, x = retest_reliability)) + 
  geom_point(aes(size=sample_size, shape = type), color='#00BFC4')+
  facet_grid(task_group~., switch = "y", scales = "free_y", space = "free_y") +
  theme(panel.spacing = unit(0.75, "lines"), 
        strip.placement = "outside",
        strip.text.y = element_text(angle=180, size=20),
        panel.background = element_rect(fill = NA),
        panel.grid.major = element_line(colour = "grey80"),
        legend.position = 'bottom') + 
  xlab("")+
  ylab("")+
  scale_x_continuous(limits = c(-0.25,1), breaks=c(-0.25, 0, 0.25, 0.5, 0.75, 1))+
  scale_shape_manual(breaks = sort(fig_data$type), values = c(15, 16, 17, 3))+
  geom_vline(xintercept = 0, color = "red", size = 1)

p2 = fig_data_poster %>%
  filter(task == 'survey') %>%
ggplot(aes(y = var, x = retest_reliability)) + 
  geom_point(aes(size=sample_size, shape = type), color = '#F8766D')+
  facet_grid(task_group~., switch = "y", scales = "free_y", space = "free_y") +
  theme(panel.spacing = unit(0.75, "lines"), 
        strip.placement = "outside",
        strip.text.y = element_text(angle=180, size=20),
        panel.background = element_rect(fill = NA),
        panel.grid.major = element_line(colour = "grey80")) + 
  xlab("")+
  ylab("")+
  scale_x_continuous(limits = c(-0.25,1), breaks=c(-0.25, 0, 0.25, 0.5, 0.75, 1))+
  scale_shape_manual(breaks = sort(fig_data$type), values = c(15, 17, 3))+
  geom_vline(xintercept = 0, color = "red", size = 1)

mylegend<-g_legend(p1_legend)

p3 <- arrangeGrob(arrangeGrob(p1 +theme(legend.position="none"),
                         p2 + theme(legend.position="none"),
                         nrow=1),
             mylegend, nrow=2,heights=c(12, 1))

ggsave('Lit_Review_Poster_Plot.jpg', plot = p3, device = "jpeg", path = "../output/figures/", width = 48, height = 23, units = "in")

```

Bootstrapped reliabilities figure mirroring lit review figure
(excludes DDM)

```{r warning=FALSE, message=FALSE}
boot_df_poster = boot_df[boot_df$dv %in% poster_vars$var,]

boot_df_poster = boot_df_poster%>%
  separate(dv, c("task_group", "var"), sep="\\.",remove=FALSE,extra="merge") %>%
  mutate(task_group = factor(task_group, levels = task_group[order(task)])) %>%
  separate(var, c("var"), sep="\\.",remove=TRUE,extra="drop") %>%
  mutate(task_group = gsub("_", " ", task_group),
         var = gsub("_", " ", var)) %>%
  arrange(task_group, var)

boot_df_poster = boot_df_poster %>%
  left_join(rel_df[,c("dv", "icc")], by = "dv") %>%
  rename(icc = icc.x, point_est = icc.y)

#Manual correction
boot_df_poster = boot_df_poster %>%
  mutate(task = ifelse(task_group == 'holt laury survey', "task", task))
```


```{r warning=FALSE, message=FALSE} 
p4 <- boot_df_poster %>%
  filter(task == 'task') %>%
ggplot(aes(y = var, x = icc)) + 
  geom_point(color = '#00BFC4')+
  geom_point(aes(y = var, x = point_est), color = "black")+
  facet_grid(task_group~., switch = "y", scales = "free_y", space = "free_y") +
  theme(panel.spacing = unit(0.75, "lines"), 
        strip.placement = "outside",
        strip.text.y = element_text(angle=180, size=20),
        panel.background = element_rect(fill = NA),
        panel.grid.major = element_line(colour = "grey80")) + 
  xlab("")+
  ylab("")+
  scale_x_continuous(limits = c(-0.25,1), breaks=c(-0.25, 0, 0.25, 0.5, 0.75, 1))+
  scale_shape_manual(breaks = sort(fig_data$type), values = c(15, 17, 3))+
  geom_vline(xintercept = 0, color = "red", size = 1)

p5 <- boot_df_poster %>%
  filter(task == 'survey') %>%
ggplot(aes(y = var, x = icc)) + 
  geom_point(color = '#F8766D')+
  geom_point(aes(y = var, x = point_est), color = "black")+
  facet_grid(task_group~., switch = "y", scales = "free_y", space = "free_y") +
  theme(panel.spacing = unit(0.75, "lines"), 
        strip.placement = "outside",
        strip.text.y = element_text(angle=180, size=20),
        panel.background = element_rect(fill = NA),
        panel.grid.major = element_line(colour = "grey80")) + 
  xlab("")+
  ylab("")+
  scale_x_continuous(limits = c(-0.25,1), breaks=c(-0.25, 0, 0.25, 0.5, 0.75, 1))+
  scale_shape_manual(breaks = sort(fig_data$type), values = c(15, 17, 3))+
  geom_vline(xintercept = 0, color = "red", size = 1)
  
p6 <- arrangeGrob(p4, p5,nrow=1)

ggsave('Bootstrap_Poster_Plot.jpg', plot = p6, device = "jpeg", path = "../output/figures/", width = 48, height = 23, units = "in")
```

Histogram of point estimates comparing distributions of survey vs. task measures

```{r warning=FALSE, message=FALSE}
p7 <- ggplot_build(rel_df %>%
               ggplot(aes(icc, fill=task)) +
               geom_histogram(position = 'identity', alpha=0.5))$data[[1]] %>%
  mutate(task=ifelse(as.character(fill) == "#00BFC4", "task", "survey")) %>%
  ggplot(aes(x,y, fill=task))+
  geom_bar(stat='identity', position='identity', alpha=0.5)+
  xlab('ICC')+
  ylab('Count')+
  theme_bw()+
  theme(legend.position="bottom",
        legend.title = element_blank(),
        legend.text= element_text(size=30),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.title.x = element_text(size = 30),
        axis.title.y = element_text(size = 30))

ggsave('Point_Est_Hist_Poster.jpg', plot = p7, device = "jpeg", path = "../output/figures/", width = 10, height = 10, units = "in")
```

Stats comparing reliabilities of surveys vs tasks

```{r}
summary(lm(icc ~ task, data=rel_df))
```

Table for survey reliabilities by survey name

```{r}
rel_df
```

Stats checking if item number makes a difference for reliability estimates for surveys

```{r warning=FALSE, message=FALSE}
survey_labels = fig_data %>%
  separate(dv, c("task_group", "var"), sep="\\.",remove=FALSE,extra="merge") %>%
  mutate(task_group = factor(task_group, levels = task_group[order(task)])) %>%
  distinct(task_group, .keep_all=T) %>%
  select(-dv, -var, -measure_description, -retest_reliability, -type, -days, -sample_size, -reference) %>%
  filter(task == "survey")

tmp = rel_df %>%
  separate(dv, c("task_group", "var"), sep="\\.",remove=FALSE,extra="merge") %>%
  mutate(task_group = factor(task_group, levels = task_group[order(task)])) %>%
  filter(task == "survey") %>%
  left_join(survey_labels, by = "task_group") %>%
  na.omit()

summary(lm(icc ~ num_all_trials,data = tmp))
```

Table for task reliabilities by task name

```{r}
survey_rel_table = boot_df %>%
  filter(task == "survey") %>%
  separate(dv, c("task_group", "var"), sep="\\.",remove=FALSE,extra="merge") %>%
  group_by(task_group) %>%
  summarise(min_icc = min(icc),
            mean_icc = mean(icc),
            max_icc = max(icc)) %>%
  mutate(task_group = gsub("_", " ", task_group))

names(survey_rel_table) <- c("Survey", "Min ICC", "Mean ICC", "Max ICC")
write.csv(survey_rel_table, "../output/figures/survey_rel_table.csv")
```

Stats checking if item number makes a difference for reliability estimates for tasks

```{r warning=FALSE, message=FALSE}
measure_labels <- read.csv('../input/measure_labels.csv')

measure_labels = measure_labels %>%
  select(dv, task, variable_type, ddm_task, num_all_trials)%>%
  separate(dv, c("task_group", "var"), sep="\\.",remove=FALSE,extra="merge") %>%
  mutate(task_group = factor(task_group, levels = task_group[order(task)])) %>%
  distinct(task_group, .keep_all=T) %>%
  filter(task == "task") %>%
  select(-dv, -var, -task)

tmp = rel_df %>%
  separate(dv, c("task_group", "var"), sep="\\.",remove=FALSE,extra="merge") %>%
  mutate(task_group = factor(task_group, levels = task_group[order(task)])) %>%
  filter(task == "task") %>%
  left_join(measure_labels, by = "task_group") %>%
  na.omit()

summary(lm(icc ~ num_all_trials,data = tmp))
```

Table for task reliabilities by task name

```{r}
task_rel_table = boot_df %>%
  filter(task == "task") %>%
  separate(dv, c("task_group", "var"), sep="\\.",remove=FALSE,extra="merge") %>%
  group_by(task_group) %>%
  summarise(min_icc = min(icc),
            mean_icc = mean(icc),
            max_icc = max(icc)) %>%
  mutate(task_group = gsub("_", " ", task_group))

names(task_rel_table) <- c("Task", "Min ICC", "Mean ICC", "Max ICC")
write.csv(task_rel_table, "../output/figures/task_rel_table.csv")
```

Histogram of DDM vs. RT and accuracy measures

```{r warning=FALSE, message=FALSE}
measure_labels <- read.csv('../input/measure_labels.csv')

p8 = measure_labels %>%
  select(dv, task, variable_type, ddm_task, num_all_trials)%>%
  separate(dv, c("task_group", "var"), sep="\\.",remove=FALSE,extra="merge") %>%
  mutate(task_group = factor(task_group, levels = task_group[order(task)])) %>%
  filter(task == "task") %>%
  select(-var, -task) %>%
  left_join(rel_df[,c("dv", "icc")], by="dv")%>%
  filter(ddm_task == 1) %>%
  separate(variable_type, c("overall_difference", "raw_EZ_hddm", "param"), extra="merge") %>%
  na.omit() %>%
  ggplot(aes(icc))+
  geom_histogram(aes(fill=param),  alpha=0.5, position = 'identity')+
  facet_wrap(~raw_EZ_hddm)+
  theme_bw()+
  theme(legend.position="bottom",
        legend.title = element_blank(),
        legend.text= element_text(size=30),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.title.x = element_text(size = 30),
        axis.title.y = element_text(size = 30),
        strip.text = element_text(size=30))

ggsave('DDM_raw_comp_Poster.jpg', plot = p8, device = "jpeg", path = "../output/figures/", width = 18, height = 5, units = "in")
```

Statistics comparing average reliabilities for DDM vs raw measures

```{r warning=FALSE, message=FALSE}
tmp = measure_labels %>%
  select(dv, task, variable_type, ddm_task, num_all_trials)%>%
  separate(dv, c("task_group", "var"), sep="\\.",remove=FALSE,extra="merge") %>%
  mutate(task_group = factor(task_group, levels = task_group[order(task)])) %>%
  filter(task == "task") %>%
  select(-var, -task) %>%
  left_join(rel_df[,c("dv", "icc")], by="dv")%>%
  filter(ddm_task == 1) %>%
  separate(variable_type, c("overall_difference", "raw_EZ_hddm", "param"), extra="merge") %>%
  na.omit()

summary(lm(icc~raw_EZ_hddm, data=tmp[tmp$raw_EZ_hddm != "raw",]))
```


```{r}
summary(lm(icc~raw_EZ_hddm, data=tmp[tmp$raw_EZ_hddm != "EZ",]))
```

```{r}
summary(lm(icc~raw_EZ_hddm, data=tmp[tmp$raw_EZ_hddm != "hddm",]))
```


Note on metric for retest reliabilities
Scatter plots showing relationships between ICC, Pearson and Spearman

```{r}
p9 = rel_df %>%
  ggplot(aes(icc, spearman, color=task))+
  geom_point()+
  geom_abline(intercept = 0, slope=1))+
  theme_bw()+
  theme(legend.position="bottom",
        legend.title = element_blank(),
        legend.text= element_text(size=30),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.title.x = element_text(size = 30),
        axis.title.y = element_text(size = 30),
        strip.text = element_text(size=30))

ggsave('ICC_Spearman_Poster.jpg', plot = p9, device = "jpeg", path = "../output/figures/", width = 10, height = 10, units = "in")
```